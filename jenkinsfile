pipeline {
  agent any
  tools {
    maven 'maven-3.6.3'
  }
  stages{
    stage('clone') {
      steps {
        checkout scm
      }
    }
    stage('Build') {
      steps {
        sh 'mvn clean install'
      }
      post {
          always {
              archiveArtifacts artifacts: '**/*.war', onlyIfSuccessful: true
          }
      }
    }
    stage('sonarqube-scanning'){
      steps {
        withSonarQubeEnv('My SonarQube Server') {
          sh 'mvn sonar:sonar \
                -Dsonar.projectKey=online-book-store \
                -Dsonar.projectName="online-book-store" \
                -Dsonar.token=squ_c7fbb3bf3647607967ac2ed5a162ed0c5603bc67'
        }
      }
    }
    stage("Quality Gate") {
        steps {
          retry(3) {
            sh 'sleep 30s'
            waitForQualityGate abortPipeline: true
          }
        }
    }
    stage('Upload to Artifactory') {
            steps {
                script {
                    // Define a new Artifactory server instance
                    def server = Artifactory.server 'jfrog-instance'  // Replace 'ServerID' with your Artifactory server ID from Jenkins configuration.
                    
                    // Define the artifact
                    def uploadSpec = """{
                        "files": [
                            {
                                "pattern": "**/*.war",
                                "target": "online-bookstore/${BUILD_ID}/*.war"
                            }
                        ]
                    }"""

                    // Upload the artifact
                    server.upload(uploadSpec)
                }
            }
        }
  }
}
